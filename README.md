# Battleship Telegram Bot

Двухпользовательский «Морской бой» на базе `python-telegram-bot` v20 и FastAPI вебхука.

## Запуск

1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Установите переменные окружения:
   - `BOT_TOKEN` — токен вашего бота Telegram.
   - `WEBHOOK_URL` — публичный URL, по которому доступен сервер (без `/webhook`).
   - `BOARD15_ENABLED` — установите `1`, чтобы включить режим игры втроем на поле 15×15.
   - `BOARD15_TEST_ENABLED` — установите `1`, чтобы добавить тестовый режим для трех игроков, в котором все ходы делает один пользователь через команду `/board15test`.
3. Запустите сервер (скрипт проверит наличие необходимых переменных окружения):
   ```bash
   ./start.sh
   ```
   или напрямую:
   ```bash
   uvicorn app.main:app --host 0.0.0.0 --port 8000
   ```

## Развертывание на Render

1. Создайте Web Service на основе этого репозитория.
2. После первого деплоя откройте **Settings → Environment** и добавьте переменные:
   - `BOT_TOKEN` — токен вашего бота (тип Secret).
   - `WEBHOOK_URL` — публичный адрес сервиса без `/webhook`, например `https://<имя-сервиса>.onrender.com`.
3. В **Start Command** укажите:
   ```bash
   uvicorn app.main:app --host 0.0.0.0 --port $PORT
   ```
   Переменная `PORT` предоставляется Render автоматически.
4. При деплое Render установит зависимости из `requirements.txt` и запустит сервис.

## Игра
- Игрок A отправляет `/newgame` и получает ссылку-приглашение.
- Игрок B переходит по ссылке или передает `/start inv_<id>`.
- Каждый пишет `авто` для автоматической расстановки флота.
- Ходы делаются текстовыми координатами, например `д5` или `g7`.
- Поля выводятся в формате `<pre>` моноширинного текста.
- Команда `/board` показывает ваше поле и известные клетки соперника.
- При установке переменной `BOARD15_TEST_ENABLED=1` доступна команда `/board15test` для одиночного тестирования режима на трех игроков.
- Если игрок участвует в нескольких матчах одновременно, бот выбирает матч по текущему чату.

## Персистентность
Матчи сохраняются на диск в файлах `data.json` и `data15.json`. Запись включает поле `last_highlight` — список координат последних подсвеченных клеток. Это позволяет после перезапуска бота восстанавливать подсветку последнего выстрела.
